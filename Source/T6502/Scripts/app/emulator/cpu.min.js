var Emulator;(function(n){var t=function(){function t(t,i,r){var u=this;this.memory=new Array(Constants.Memory.Size),this.runner=null,this.instructions=0,this.lastCheck=0,this.operationMap=[],this.consoleService=t,this.displayService=i,this.log=function(n){return u.consoleService.log(n)},this.timeoutService=r,n.OpCodes.FillOps(this.operationMap),this.autoRefresh=!0,this.reset()}return t.prototype.stop=function(){this.runningState=!1,this.runner!=null&&(this.timeoutService.cancel(this.runner),this.runner=null)},t.prototype.halt=function(){this.stop(),this.errorState=!0,this.consoleService.log("Processing has been halted. RESET to continue.")},t.prototype.reset=function(){var n,t;for(this.rA=0,this.rX=0,this.rY=0,this.rP=0,this.rPC=Constants.Memory.DefaultStart,this.rSP=Constants.Memory.Stack,this.started=null,this.elapsedMilliseconds=0,this.instructionsPerSecond=null,this.lastCheck=null,this.instructions=0,n=0;n<this.memory.length;n++)this.memory[n]=0;for(t=[169,225,133,0,169,251,133,1,160,32,162,0,65,0,145,0,230,0,208,246,230,1,208,242,162,0,254,0,252,254,0,253,254,0,254,254,0,255,232,76,26,192],n=0;n<t.length;n++)this.poke(Constants.Memory.DefaultStart+n,t[n]);for(n=0;n<this.displayService.pixels.length;n++)this.displayService.pixels[n]!==0&&this.displayService.draw(n,0);this.runningState=!1,this.errorState=!1,this.consoleService.log("CPU has been successfully reset.")},t.prototype.run=function(){var n=this;if(this.runningState){this.consoleService.log("Already running.");return}if(this.errorState){this.consoleService.log("Cannot run in error state. Please RESET first.");return}this.runningState=!0,this.started=new Date,this.lastCheck=this.started.getTime(),this.runner=this.timeoutService(function(){return n.execute.apply(n)},1,this.autoRefresh)},t.prototype.execute=function(){var t=this,n;if(this.runningState&&!this.errorState){try{this.operationMap[this.addrPop()].execute(this)}catch(i){this.consoleService.log("Unexpected exception: "+i),this.halt()}this.instructions+=1,n=new Date,this.elapsedMilliseconds=n.getTime()-this.started.getTime(),n.getTime()-this.lastCheck>1e3&&(this.instructionsPerSecond=this.instructions,this.instructions=0,this.lastCheck=n.getTime()),this.runner=this.timeoutService(function(){return t.execute.apply(t)},0,this.autoRefresh)}},t.prototype.stackPush=function(n){if(this.rSP>=0)return this.rSP-=1,this.memory[this.rSP+Constants.Memory.Stack]=n,!0;throw"Stack overflow.";},t.prototype.stackPop=function(){if(this.rSP<Constants.Memory.Stack){var n=this.memory[this.rSP+Constants.Memory.Stack];return this.rSP++,n}throw"Tried to pop empty stack.";},t.prototype.stackRts=function(){this.rPC=this.stackPop()+1+(this.stackPop()<<Constants.Memory.BitsInByte)},t.prototype.addrPop=function(){var n=this.memory[this.rPC];return this.rPC+=1,n},t.prototype.addrPopWord=function(){return this.addrPop()+(this.addrPop()<<Constants.Memory.BitsInByte)},t.prototype.poke=function(n,t){this.memory[n]=t,n>=61440&&n<=65535&&this.displayService.draw(n,t)},t.prototype.peek=function(n){return this.memory[n]},t.prototype.setFlags=function(n){n&Constants.ProcessorStatus.NegativeFlagSet?this.rP|=Constants.ProcessorStatus.NegativeFlagSet:this.rP&=Constants.ProcessorStatus.NegativeFlagReset,n?this.rP&=Constants.ProcessorStatus.ZeroFlagReset:this.rP|=Constants.ProcessorStatus.ZeroFlagSet},t.prototype.compareWithFlags=function(n,t){var i=n+t;i>Constants.Memory.ByteMask?this.rP|=Constants.ProcessorStatus.CarryFlagSet:this.rP&=Constants.ProcessorStatus.CarryFlagReset,this.setFlags(n-t)},t.prototype.getOperation=function(n){return this.operationMap[n&Constants.Memory.ByteMask]},t}();n.Cpu=t})(Emulator||(Emulator={}))