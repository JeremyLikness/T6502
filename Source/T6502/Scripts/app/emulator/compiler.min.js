var Emulator;(function(n){var t=function(){function t(n,t){this.opCode=/^\s*([A-Z]{3})\s*\S*/,this.notWhitespace=/\S/,this.whitespaceTrim=/^\s+/,this.whitespaceTrimEnd=/\s+$/,this.comment=/^\;.*/,this.memoryLabelHex=/^(\$[0-9A-F]+):.*/,this.memoryLabelDec=/^([0-9]+):.*/,this.regularLabel=/^(\w+):.*/,this.memorySet=/^\*\s*\=\s*[\$]?[0-9A-F]*$/,this.setAddress=/^[\s]*\*[\s]*=[\s]*/,this.immediate=/^\#\$?([0-9A-F]{1,3})\s*/,this.immediateLabel=/^\#([<>])(\w+)\s*/,this.indirectX=/^\(\$?([0-9A-F]{1,3})(\,\s*X)\)\s*/,this.indirectY=/^\(\$?([0-9A-F]{1,3})\)(\,\s*Y)\s*/,this.absoluteX=/^\$?([0-9A-F]{1,5})(\,\s*X)\s*/,this.absoluteXLabel=/^(\w+)(\,\s*X)\s*/,this.absoluteY=/^\$?([0-9A-F]{1,5})(\,\s*Y)\s*/,this.absoluteYLabel=/^(\w+)(\,\s*Y)\s*/,this.indirect=/^\(\$?([0-9A-F]{1,5})\)(^\S)*(\s*\;.*)?$/,this.indirectLabel=/^\(([A-Z_][A-Z0-9_]+)\)\s*/,this.absolute=/^\$?([0-9A-F]{1,5})(^\S)*(\s*\;.*)?$/,this.absoluteLabel=/^([A-Z_][A-Z0-9_]+)\s*/,this.cpu=n,this.consoleService=t,this.opCodeCache={}}return t.prototype.decompile=function(n){for(var t=n&Constants.Memory.Max,i=0,r=[];i<Constants.Memory.MaxInstructionsDecompile&&t<=Constants.Memory.Max;){var u=this.cpu.peek(t),e=[u,this.cpu.peek(t+1),this.cpu.peek(t+2)],f=this.cpu.getOperation(u);r.push(f.decompile(t,e)),i+=1,t+=f.sizeBytes}return r.join("\r\n")},t.prototype.compile=function(n){var f=n.split("\n"),t,r,i,u;this.pcAddress=this.cpu.rPC,this.consoleService.log("Starting compilation.");try{for(t=this.parseLabels(f),t=this.compileSource(t),this.consoleService.log("Compilation complete."),r=0;r<t.compiledLines.length;r++)for(u=t.compiledLines[r],i=0;i<u.code.length;i++)this.cpu.poke(u.address+i,u.code[i]);this.consoleService.log("Code loaded to memory."),this.cpu.rPC=this.pcAddress}catch(e){return this.consoleService.log(e),!1}return!0},t.prototype.parseLabels=function(n){var r=Constants.Memory.DefaultStart,i,h=0,c=0,u,f={labels:[],compiledLines:[]},t,e,o,s;for(this.consoleService.log("Starting compilation pass 1."),u=0;u<n.length;u++)if(t=n[u].toUpperCase(),t=this.trimLine(t),t.match(this.notWhitespace)){if(e=this.moveAddress(t),!isNaN(e)){this.pcAddress=e,r=e;continue}if(t.match(this.memoryLabelHex)||t.match(this.memoryLabelDec)){if(h++,o=t.match(this.memoryLabelHex),i=o?this.memoryLabelHex.exec(t)[1]:this.memoryLabelDec.exec(t)[1],t=t.replace(i+":",""),i=i.replace("$",""),r=parseInt(i,o?16:10),r<0||r>Constants.Memory.Max)throw"Address out of range: "+i;this.pcAddress=r}else if(t.match(this.regularLabel)){if(i=this.regularLabel.exec(t)[1],this.labelExists(i,f.labels))throw"Duplicate label "+i+" found at line "+(u+1);f.labels.push({address:r,labelName:i}),c++,t=t.replace(i+":","")}if(t.match(this.notWhitespace))try{s=this.compileLine(f.labels,r,t),f.compiledLines.push(s),r+=s.code.length}catch(l){throw l+" Line: "+(u+1);}}return this.consoleService.log("Parsed "+h+" memory tags and "+c+" labels."),f},t.prototype.compileLine=function(n,t,i){var r={address:t,code:[],operation:null,processed:!1,label:"",high:!1};if(i.match(this.opCode))r=this.parseOpCode(n,i,r);else throw"Invalid assembly "+i;return r},t.prototype.trimLine=function(n){return this.notWhitespace.test(n)?this.comment.test(n)?"":n.replace(this.whitespaceTrim,"").replace(this.whitespaceTrimEnd,""):""},t.prototype.moveAddress=function(n){var t,i=NaN;if(n.match(this.memorySet)&&(t=n.replace(this.setAddress,""),t[0]==="$"?(t=t.replace("$",""),i=parseInt(t,16)):i=parseInt(t,10),i<0||i>Constants.Memory.Max))throw"Address out of range";return i},t.prototype.getOperationForMode=function(n,t){for(var i=0,i=0;i<n.length;i++)if(n[i].addressingMode===t)return n[i];return null},t.prototype.parseOpCode=function(t,i,r){var k=this.opCode.exec(i),e,o,s,f,a,v,h=k[1],c=[],u,p,y,l,b,w;if(h in this.opCodeCache)c=this.opCodeCache[h];else if(c=n.OpCodes.LoadOpCodesByName(h),c.length>0)this.opCodeCache[h]=c;else throw"Invalid op code: "+h;if(l=!0,u=this.trimLine(i.replace(h,"")),c[0].addressingMode===n.OpCodes.ModeRelative){if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absolute,this.absoluteLabel),l=r.processed,e=u.match(this.absolute)){if(o=u[0]==="$",s=e[1],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(o&&(u=u.replace("$","")),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;return r.operation=c[0],r.code.push(r.operation.opCode),b=f<=r.address?Constants.Memory.ByteMask-(r.address+1-f):f-r.address-2,r.code.push(b&Constants.Memory.ByteMask),r.processed=l,r}throw"Invalid branch.";}if(!u.match(this.notWhitespace)){if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeSingle),r.operation===null)throw"Opcode requires a parameter "+h;return r.code.push(r.operation.opCode),r.processed=l,r}if(e=u.match(this.indirectX)){if(o=u[1]==="$",s=e[1],a=e[2],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.ByteMask)throw"Indirect X-Indexed value of out range: "+f;if(o&&(u=u.replace("$","")),u=u.replace("(","").replace(")",""),u=u.replace(a,""),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeIndexedIndirectX),r.operation===null)throw"Opcode doesn't support indirect X-indexed mode "+h;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.processed=l,r}if(e=u.match(this.indirectY)){if(o=u[1]==="$",s=e[1],v=e[2],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.ByteMask)throw"Indexed Indirect-Y value of out range: "+f;if(o&&(u=u.replace("$","")),u=u.replace("(","").replace(")",""),u=u.replace(v,""),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeIndexedIndirectY),r.operation===null)throw"Opcode doesn't support indirected indexed-Y mode "+h;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.processed=l,r}if(u.match(this.immediate)||(e=u.match(this.immediateLabel))&&(r.high=e[1]===">",p=e[2],y=this.findLabel(p,t),y!==null?(f=r.high?y.address>>Constants.Memory.BitsInByte:y.address,u=u.replace(e[0],"#"+(f&Constants.Memory.ByteMask).toString(10))):(r.label=p,l=!1,u=u.replace(e[0],"#0"))),e=u.match(this.immediate)){if(o=u[1]==="$",s=e[1],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.ByteMask)throw"Immediate value of out range: "+f;if(u=u.replace(o?"#$":"#",""),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeImmediate),r.operation===null)throw"Opcode doesn't support immediate mode "+h;return r.code.push(r.operation.opCode),r.code.push(f),r.processed=l,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absoluteX,this.absoluteXLabel),l=r.processed,e=u.match(this.absoluteX)){if(o=u[0]==="$",s=e[1],a=e[2],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.Size)throw"Absolute X-Indexed value of out range: "+f;if(o&&(u=u.replace("$","")),u=u.replace(a,""),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeAbsoluteX),r.operation===null)throw"Opcode doesn't support absolute X-indexed mode "+h;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=l,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absoluteY,this.absoluteYLabel),l=r.processed,e=u.match(this.absoluteY)){if(o=u[0]==="$",s=e[1],v=e[2],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.Size)throw"Absolute Y-Indexed value of out range: "+f;if(o&&(u=u.replace("$","")),u=u.replace(v,""),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeAbsoluteY),r.operation===null)throw"Opcode doesn't support absolute Y-indexed mode "+h;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=!0,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.indirect,this.indirectLabel),l=r.processed,e=u.match(this.indirect)){if(o=u[1]==="$",s=e[1],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(o&&(u=u.replace("$","")),u=u.replace("(","").replace(")",""),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(c,n.OpCodes.ModeIndirect),r.operation===null)throw"Opcode doesn't support indirect mode "+h;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=l,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absolute,this.absoluteLabel),l=r.processed,e=u.match(this.absolute)){if(o=u[0]==="$",s=e[1],f=parseInt(s,o?16:10),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(o&&(u=u.replace("$","")),u=this.trimLine(u.replace(s,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(w=f<=Constants.Memory.ByteMask?n.OpCodes.ModeZeroPage:n.OpCodes.ModeAbsolute,r.operation=this.getOperationForMode(c,w),r.operation===null)throw"Opcode doesn't support absolute mode "+h;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),w===n.OpCodes.ModeAbsolute&&r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=!0,r}throw"Unable to parse "+i;},t.prototype.compileSource=function(t){var u,i,r,f,e;for(this.consoleService.log("Starting compilation pass 2."),u=0;u<t.compiledLines.length;u++)if(i=t.compiledLines[u],!i.processed){if(r=this.findLabel(i.label,t.labels),r===null)throw"Label not defined: "+i.label;if(i.operation.sizeBytes===2){i.operation.addressingMode===n.OpCodes.ModeRelative?(f=r.address<=i.address?Constants.Memory.ByteMask-(i.address+1-r.address):r.address-i.address-2,i.code[1]=f&Constants.Memory.ByteMask):(e=i.high?r.address>>Constants.Memory.BitsInByte:r.address,i.code[1]=e&Constants.Memory.ByteMask),i.processed=!0;continue}else if(i.operation.sizeBytes===3){i.code[1]=r.address&Constants.Memory.ByteMask,i.code[2]=r.address>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask,i.processed=!0;continue}throw"Not implemented";}return t},t.prototype.labelExists=function(n,t){return this.findLabel(n,t)!==null},t.prototype.findLabel=function(n,t){for(var i=0;i<t.length;i++)if(t[i].labelName===n)return t[i];return null},t.prototype.parseAbsoluteLabel=function(n,t,i,r,u){var f,e,o,s;return n.match(r)||(f=n.match(u))&&(e=f[1],o=this.findLabel(e,i),o!==null?(s=o.address,n=n.replace(f[1],s.toString(10))):(t.label=e,t.processed=!1,n=n.replace(f[1],"65535"))),n},t}();n.Compiler=t})(Emulator||(Emulator={}))