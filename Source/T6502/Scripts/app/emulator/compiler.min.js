var Emulator;(function(n){var t=function(){function t(n,t){this.opCode=/^\s+([A-Za-z]{3})\s*(\S*)/,this.cpu=n,this.consoleService=t,this.opCodeCache={}}return t.prototype.decompile=function(n){for(var t=n&Constants.Memory.Max,i=0,r=[];i<Constants.Memory.MaxInstructionsDecompile&&t<=Constants.Memory.Max;){var u=this.cpu.peek(t),e=[u,this.cpu.peek(t+1),this.cpu.peek(t+2)],f=this.cpu.getOperation(u);r.push(f.decompile(t,e)),i+=1,t+=f.sizeBytes}return r.join("\r\n")},t.prototype.compile=function(n){var i=n.split("\n"),t;this.consoleService.log("Starting compilation.");try{t=this.compileSource(i),this.consoleService.log("Compilation passes complete; moving buffer into memory at $"+t.startAddress.toString(16).toUpperCase())}catch(r){this.consoleService.log(r)}},t.prototype.compileSource=function(n){var u={startAddress:Constants.Memory.DefaultStart,opCodes:[]},y=u.startAddress,f=!1,e=!1,o=/\S/,s=/^\;.*/,h=/^(\$\w+):.*/,c=/^(\w+):.*/,l=[],i,a=0,v=0,r,t,p;for(this.consoleService.log("Starting compilation pass 1."),r=0;r<n.length;r++)if((t=n[r],o.test(t))&&!s.test(t)){if(t=t.replace(/^\s+/,"").replace(/\s+$/,""),t.match(h))a++,i=h.exec(t)[1],t=t.replace(i+":",""),f?e=!0:(f=!0,i=i.replace("$",""),u.startAddress=parseInt(i,16));else if(t.match(c)){if(i=c.exec(t)[1].toUpperCase(),this.labelExists(i,l))throw"Duplicate label "+i+" found at line "+(r+1);l.push({address:y,labelName:i}),v++,t=t.replace(i+":","")}if(!t.match(s)&&t.match(o))if(t.match(this.opCode))try{p=this.parseOpCode(t)}catch(w){throw w+" (Line "+(r+1)+").";}else throw"Invalid assembly line "+(r+1)+": "+n[r]+".";}return e&&this.consoleService.log("Compilation address may only be set once. Some memory labels were ignored."),this.consoleService.log("Parsed "+a+" memory tags and "+v+" labels."),u},t.prototype.parseOpCode=function(t){var u=this.opCode.exec(t),i=u[1].toUpperCase(),r=[];if(i in this.opCodeCache)r=this.opCodeCache[i];else if(r=n.OpCodes.LoadOpCodesByName(i),r.length>0)this.opCodeCache[i]=r;else throw"Invalid op code: "+i;return[]},t.prototype.labelExists=function(n,t){for(var i=0;i<t.length;i++)if(t[i].labelName===n)return!0;return!1},t}();n.Compiler=t})(Emulator||(Emulator={}))