var Emulator;(function(n){var t=function(){function t(n,t){this.opCode=/^\s*([A-Z]{3})\s*\S*/,this.notWhitespace=/\S/,this.whitespaceTrim=/^\s+/,this.whitespaceTrimEnd=/\s+$/,this.comment=/^\;.*/,this.memoryLabelHex=/^(\$[0-9A-F]+):.*/,this.memoryLabelDec=/^([0-9]+):.*/,this.regularLabel=/^(\w+):.*/,this.memorySet=/^\*[\s]*=[\s]*[\$]?[0-9a-f]*$/,this.setAddress=/^[\s]*\*[\s]*=[\s]*/,this.removeHex=/^\$/,this.immediateHex=/^\#\$([0-9A-F]{1,2})\s*/,this.immediateDec=/^\#(\d{1,3})\s*/,this.cpu=n,this.consoleService=t,this.opCodeCache={}}return t.prototype.decompile=function(n){for(var t=n&Constants.Memory.Max,i=0,r=[];i<Constants.Memory.MaxInstructionsDecompile&&t<=Constants.Memory.Max;){var u=this.cpu.peek(t),e=[u,this.cpu.peek(t+1),this.cpu.peek(t+2)],f=this.cpu.getOperation(u);r.push(f.decompile(t,e)),i+=1,t+=f.sizeBytes}return r.join("\r\n")},t.prototype.compile=function(n){var f=n.split("\n"),t,r,i,u;this.pcAddress=this.cpu.rPC,this.consoleService.log("Starting compilation.");try{for(t=this.parseLabels(f),t=this.compileSource(t),this.consoleService.log("Compilation complete."),r=0;r<t.compiledLines.length;r++)for(u=t.compiledLines[r],i=0;i<u.code.length;i++)this.cpu.poke(u.address+i,u.code[i]);this.consoleService.log("Code loaded to memory."),this.cpu.rPC=this.pcAddress}catch(e){return this.consoleService.log(e),!1}return!0},t.prototype.parseLabels=function(n){var u=Constants.Memory.DefaultStart,i,h=0,c=0,r,f={labels:[],compiledLines:[]},t,e,o,s;for(this.consoleService.log("Starting compilation pass 1."),r=0;r<n.length;r++)if(t=n[r].toUpperCase(),t=this.trimLine(t),t.match(this.notWhitespace)){if(e=this.moveAddress(t),!isNaN(e)){this.pcAddress=e,u=e;continue}if(t.match(this.memoryLabelHex)||t.match(this.memoryLabelDec))h++,o=t.match(this.memoryLabelHex),i=o?this.memoryLabelHex.exec(t)[1]:this.memoryLabelDec.exec(t)[1],t=t.replace(i+":",""),i=i.replace(this.removeHex,""),u=parseInt(i,o?16:10);else if(t.match(this.regularLabel)){if(i=this.regularLabel.exec(t)[1],this.labelExists(i,f.labels))throw"Duplicate label "+i+" found at line "+(r+1);f.labels.push({address:u,labelName:i}),c++,t=t.replace(i+":","")}if(t.match(this.notWhitespace))try{s=this.compileLine(f.labels,u,t),f.compiledLines.push(s),u+=s.code.length}catch(l){throw l+" Line: "+(r+1);}}return this.consoleService.log("Parsed "+h+" memory tags and "+c+" labels."),f},t.prototype.compileLine=function(n,t,i){var r={address:t,code:[],processed:!1,label:""};if(i.match(this.opCode))r=this.parseOpCode(n,i,r);else throw"Invalid assembly "+i;return r},t.prototype.compileSource=function(n){var t,i;for(this.consoleService.log("Starting compilation pass 2."),t=0;t<n.compiledLines.length;t++)if(i=n.compiledLines[t],!i.processed)throw"Not implemented";return n},t.prototype.trimLine=function(n){return this.notWhitespace.test(n)?this.comment.test(n)?"":n.replace(this.whitespaceTrim,"").replace(this.whitespaceTrimEnd,""):""},t.prototype.moveAddress=function(n){var t,i=NaN;if(n.match(this.memorySet)&&(t=n.replace(this.setAddress,""),t[0]==="$"?(t=t.replace(this.removeHex,""),i=parseInt(t,16)):i=parseInt(t,10),i<0||i>Constants.Memory.Max))throw"Address out of range";return i},t.prototype.getOperationForMode=function(n,t){for(var i=0,i=0;i<n.length;i++)if(n[i].addressingMode===t)return n[i];return null},t.prototype.parseOpCode=function(t,i,r){var l=this.opCode.exec(i),f=l[1],o=[],u,e;if(f in this.opCodeCache)o=this.opCodeCache[f];else if(o=n.OpCodes.LoadOpCodesByName(f),o.length>0)this.opCodeCache[f]=o;else throw"Invalid op code: "+f;if(u=this.trimLine(i.replace(f,"")),!u.match(this.notWhitespace)){if(e=this.getOperationForMode(o,n.OpCodes.ModeSingle),e===null)throw"Opcode requires a parameter "+f;return r.code.push(e.opCode),r.processed=!0,r}if(u.match(this.immediateHex)||u.match(this.immediateDec)){var h=u[1]==="$",c=u.match(h?this.immediateHex:this.immediateDec)[1],s=parseInt(c,h?16:10);if(s<0||s>Constants.Memory.ByteMask)throw"Immediate value of out range: "+s;if(u=u.replace(h?"#$":"#",""),u=this.trimLine(u.replace(c,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(e=this.getOperationForMode(o,n.OpCodes.ModeImmediate),e===null)throw"Opcode doesn't support immediate mode "+f;return r.code.push(e.opCode),r.code.push(s),r.processed=!0,r}return r},t.prototype.labelExists=function(n,t){for(var i=0;i<t.length;i++)if(t[i].labelName===n)return!0;return!1},t}();n.Compiler=t})(Emulator||(Emulator={}))