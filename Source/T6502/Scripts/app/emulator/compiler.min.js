var Emulator;(function(n){var t=function(){function t(n,t){this.opCode=/^\s*([A-Z]{3})\s*\S*/,this.notWhitespace=/\S/,this.whitespaceTrim=/^\s+/,this.whitespaceTrimEnd=/\s+$/,this.labelMath=/^\s*([A-Z][A-Z_0-9]+)\s*=\s*([A-Z][A-Z_0-9]+)\s*([\+\-])\s*([0-9]{1,3})\s*$/,this.memoryLabelHex=/^(\$[0-9A-F]+):.*/,this.memoryLabelDec=/^([0-9]+):.*/,this.regularLabel=/^([A-Z][A-Z_0-9]+):.*/,this.memorySet=/^\*\s*\=\s*[\$]?[0-9A-F]*$/,this.setAddress=/^[\s]*\*[\s]*=[\s]*/,this.immediate=/^\#([0-9]{1,3})\s*/,this.immediateHex=/^\#([0-9A-F]{1,2})\s*/,this.immediateLabel=/^\#([<>])([A-Z][A-Z_0-9]+)\s*/,this.indirectX=/^\(([0-9]{1,3})(\,\s*X)\)\s*/,this.indirectXHex=/^\(([0-9A-F]{1,2})(\,\s*X)\)\s*/,this.indirectY=/^\(([0-9]{1,3})\)(\,\s*Y)\s*/,this.indirectYHex=/^\(([0-9A-F]{1,2})\)(\,\s*Y)\s*/,this.absoluteX=/^([0-9]{1,5})(\,\s*X)\s*/,this.absoluteXHex=/^([0-9A-F]{1,4})(\,\s*X)\s*/,this.absoluteXLabel=/^([A-Z][A-Z_0-9]+)(\,\s*X)\s*/,this.absoluteY=/^([0-9]{1,5})(\,\s*Y)\s*/,this.absoluteYHex=/^([0-9A-F]{1,4})(\,\s*Y)\s*/,this.absoluteYLabel=/^([A-Z][A-Z_0-9]+)(\,\s*Y)\s*/,this.indirect=/^\(([0-9]{1,5})\)(^\S)*(\s*\;.*)?$/,this.indirectHex=/^\(([0-9A-F]{1,4})\)(^\S)*(\s*\;.*)?$/,this.indirectLabel=/^\(([A-Z][A-Z_0-9]+)\)\s*/,this.absolute=/^([0-9]{1,5})(^\S)*(\s*\;.*)?$/,this.absoluteHex=/^([0-9A-F]{1,4})(^\S)*(\s*\;.*)?$/,this.absoluteLabel=/^([A-Z][A-Z_0-9]+)\s*/,this.cpu=n,this.consoleService=t,this.opCodeCache={}}return t.prototype.decompile=function(n){for(var t=n&Constants.Memory.Max,i=0,r=[];i<Constants.Memory.MaxInstructionsDecompile&&t<=Constants.Memory.Max;){var u=this.cpu.peek(t),e=[u,this.cpu.peek(t+1),this.cpu.peek(t+2)],f=this.cpu.getOperation(u);r.push(f.decompile(t,e)),i+=1,t+=f.sizeBytes}return r.join("\r\n")},t.prototype.compile=function(n){var e=n.split("\n"),t,f,r,i,u;this.pcAddress=this.cpu.rPC,this.consoleService.log("Starting compilation.");try{for(t=this.parseLabels(e),t=this.compileSource(t),this.consoleService.log("Compilation complete."),f=0,r=0;r<t.compiledLines.length;r++)for(u=t.compiledLines[r],i=0;i<u.code.length;i++)this.cpu.poke(u.address+i,u.code[i]),f+=1;this.consoleService.log(f.toString(10)+" bytes of code loaded to memory."),this.cpu.rPC=this.pcAddress}catch(o){return this.consoleService.log(o),!1}return!0},t.prototype.parseLabels=function(n){var f=Constants.Memory.DefaultStart,i,p=0,h=0,r,e,c,u={labels:[],compiledLines:[]},t,s,o,l,a,v,y;for(this.consoleService.log("Starting compilation pass 1."),r=0;r<n.length;r++)if(t=n[r].toUpperCase(),t.indexOf(";")>=0&&(t=t.split(";")[0]),t=this.trimLine(t),t.match(this.notWhitespace)){if(s=this.moveAddress(t),!isNaN(s)){this.pcAddress=s,f=s;continue}if(t.match(this.labelMath)){if(o=this.labelMath.exec(t),o.length!==5)throw"Invalid label math at line "+(r+1)+": "+t;if(i=o[1],l=o[2],this.labelExists(i,u.labels))throw"Duplicate label "+i+" found at line "+(r+1);if(i===l)throw"Cannot redefine label "+i+" at line "+(r+1);a=parseInt(o[4],10),o[3]==="-"&&(a*=-1),u.labels.push({address:f,labelName:i,dependentLabelName:l,offset:a}),h++;continue}if(t.match(this.memoryLabelHex)||t.match(this.memoryLabelDec)){if(p++,v=!!t.match(this.memoryLabelHex),i=v?this.memoryLabelHex.exec(t)[1]:this.memoryLabelDec.exec(t)[1],t=t.replace(i+":",""),i=i.replace("$",""),f=parseInt(i,v?16:10),f<0||f>Constants.Memory.Max)throw"Address out of range: "+i;this.pcAddress=f}else if(t.match(this.regularLabel)){if(i=this.regularLabel.exec(t)[1],this.labelExists(i,u.labels))throw"Duplicate label "+i+" found at line "+(r+1);u.labels.push({address:f,labelName:i,dependentLabelName:undefined,offset:0}),h++,t=t.replace(i+":","")}if(t.match(this.notWhitespace))try{y=this.compileLine(u.labels,f,t),u.compiledLines.push(y),f+=y.code.length}catch(w){throw w+" Line: "+(r+1);}}for(r=0;r<u.labels.length;r++)if(e=u.labels[r],e.dependentLabelName!==undefined){if(c=this.findLabel(e.dependentLabelName,u.labels),c===null)throw"Unable to process label "+e.labelName+": missing dependent label "+e.dependentLabelName;e.address=c.address+e.offset&Constants.Memory.Max,e.dependentLabelName=undefined}return this.consoleService.log("Parsed "+p+" memory tags and "+h+" labels."),u},t.prototype.compileLine=function(n,t,i){var r={address:t,code:[],operation:null,processed:!1,label:"",high:!1};if(i.match(this.opCode))r=this.parseOpCode(n,i,r);else throw"Invalid assembly "+i;return r},t.prototype.trimLine=function(n){return this.notWhitespace.test(n)?n.replace(this.whitespaceTrim,"").replace(this.whitespaceTrimEnd,""):""},t.prototype.moveAddress=function(n){var t,i=NaN;if(n.match(this.memorySet)&&(t=n.replace(this.setAddress,""),t[0]==="$"?(t=t.replace("$",""),i=parseInt(t,16)):i=parseInt(t,10),i<0||i>Constants.Memory.Max))throw"Address out of range";return i},t.prototype.getOperationForMode=function(n,t){for(var i=0,i=0;i<n.length;i++)if(n[i].addressingMode===t)return n[i];return null},t.prototype.parseOpCode=function(t,i,r){var g=this.opCode.exec(i),e,a,o,f,y,p,c=g[1],l=[],u,b,w,h,s,v=10,d,k;if(c in this.opCodeCache)l=this.opCodeCache[c];else if(l=n.OpCodes.LoadOpCodesByName(c),l.length>0)this.opCodeCache[c]=l;else throw"Invalid op code: "+c;if(h=!0,u=this.trimLine(i.replace(c,"")),a=u.indexOf("$")>=0,a&&(u=u.replace("$",""),v=16),l[0].addressingMode===n.OpCodes.ModeRelative){if(s=a?this.absoluteHex:this.absolute,r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,s,this.absoluteLabel),h=r.processed,e=u.match(s)){if(o=e[1],f=parseInt(o,v),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;return r.operation=l[0],r.code.push(r.operation.opCode),d=f<=r.address?Constants.Memory.ByteMask-(r.address+1-f):f-r.address-2,r.code.push(d&Constants.Memory.ByteMask),r.processed=h,r}throw"Invalid branch.";}if(!u.match(this.notWhitespace)){if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeSingle),r.operation===null)throw"Opcode requires a parameter "+c;return r.code.push(r.operation.opCode),r.processed=h,r}if(s=a?this.indirectXHex:this.indirectX,e=u.match(s)){if(o=e[1],y=e[2],f=parseInt(o,v),f<0||f>Constants.Memory.ByteMask)throw"Indirect X-Indexed value of out range: "+f;if(u=u.replace("(","").replace(")",""),u=u.replace(y,""),u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeIndexedIndirectX),r.operation===null)throw"Opcode doesn't support indirect X-indexed mode "+c;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.processed=h,r}if(s=a?this.indirectYHex:this.indirectY,e=u.match(s)){if(o=e[1],p=e[2],f=parseInt(o,v),f<0||f>Constants.Memory.ByteMask)throw"Indexed Indirect-Y value of out range: "+f;if(u=u.replace("(","").replace(")",""),u=u.replace(p,""),u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeIndexedIndirectY),r.operation===null)throw"Opcode doesn't support indirected indexed-Y mode "+c;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.processed=h,r}if(s=a?this.immediateHex:this.immediate,u.match(s)||(e=u.match(this.immediateLabel))&&(r.high=e[1]===">",b=e[2],w=this.findLabel(b,t),w!==null?(f=r.high?w.address>>Constants.Memory.BitsInByte:w.address,u=u.replace(e[0],"#"+(f&Constants.Memory.ByteMask).toString(10))):(r.label=b,h=!1,u=u.replace(e[0],"#0"))),e=u.match(s)){if(o=e[1],f=parseInt(o,v),f<0||f>Constants.Memory.ByteMask)throw"Immediate value of out range: "+f;if(u=u.replace("#",""),u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeImmediate),r.operation===null)throw"Opcode doesn't support immediate mode "+c;return r.code.push(r.operation.opCode),r.code.push(f),r.processed=h,r}if(s=a?this.absoluteXHex:this.absoluteX,r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,s,this.absoluteXLabel),h=r.processed,e=u.match(s)){if(o=e[1],y=e[2],f=parseInt(o,v),f<0||f>Constants.Memory.Size)throw"Absolute X-Indexed value of out range: "+f;if(u=u.replace(y,""),u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeAbsoluteX),r.operation===null)throw"Opcode doesn't support absolute X-indexed mode "+c;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=h,r}if(s=a?this.absoluteYHex:this.absoluteY,r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,s,this.absoluteYLabel),h=r.processed,e=u.match(s)){if(o=e[1],p=e[2],f=parseInt(o,v),f<0||f>Constants.Memory.Size)throw"Absolute Y-Indexed value of out range: "+f;if(u=u.replace(p,""),u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeAbsoluteY),r.operation===null)throw"Opcode doesn't support absolute Y-indexed mode "+c;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=!0,r}if(s=a?this.indirectHex:this.indirect,r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,s,this.indirectLabel),h=r.processed,e=u.match(s)){if(o=e[1],f=parseInt(o,v),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(u=u.replace("(","").replace(")",""),u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(r.operation=this.getOperationForMode(l,n.OpCodes.ModeIndirect),r.operation===null)throw"Opcode doesn't support indirect mode "+c;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=h,r}if(s=a?this.absoluteHex:this.absolute,r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,s,this.absoluteLabel),h=r.processed,e=u.match(s)){if(o=e[1],f=parseInt(o,v),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(u=this.trimLine(u.replace(o,"")),u.match(this.notWhitespace))throw"Invalid assembly: "+i;if(k=f<=Constants.Memory.ByteMask?n.OpCodes.ModeZeroPage:n.OpCodes.ModeAbsolute,r.operation=this.getOperationForMode(l,k),r.operation===null)throw"Opcode doesn't support absolute mode "+c;return r.code.push(r.operation.opCode),r.code.push(f&Constants.Memory.ByteMask),k===n.OpCodes.ModeAbsolute&&r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=h,r}throw"Unable to parse "+i;},t.prototype.compileSource=function(t){var u,i,r,f,e;for(this.consoleService.log("Starting compilation pass 2."),u=0;u<t.compiledLines.length;u++)if(i=t.compiledLines[u],!i.processed){if(r=this.findLabel(i.label,t.labels),r===null)throw"Label not defined: "+i.label;if(i.operation.sizeBytes===2){i.operation.addressingMode===n.OpCodes.ModeRelative?(f=r.address<=i.address?Constants.Memory.ByteMask-(i.address+1-r.address):r.address-i.address-2,i.code[1]=f&Constants.Memory.ByteMask):(e=i.high?r.address>>Constants.Memory.BitsInByte:r.address,i.code[1]=e&Constants.Memory.ByteMask),i.processed=!0;continue}else if(i.operation.sizeBytes===3){i.code[1]=r.address&Constants.Memory.ByteMask,i.code[2]=r.address>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask,i.processed=!0;continue}throw"Not implemented";}return t},t.prototype.labelExists=function(n,t){return this.findLabel(n,t)!==null},t.prototype.findLabel=function(n,t){for(var i=0;i<t.length;i++)if(t[i].labelName===n&&t[i].dependentLabelName===undefined)return t[i];return null},t.prototype.parseAbsoluteLabel=function(n,t,i,r,u){var f,e,o,s;return n.match(r)||(f=n.match(u))&&(e=f[1],o=this.findLabel(e,i),o!==null?(s=o.address,n=n.replace(f[1],s.toString(10))):(t.label=e,t.processed=!1,n=n.replace(f[1],"65535"))),n},t}();n.Compiler=t})(Emulator||(Emulator={}))