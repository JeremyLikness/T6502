var Emulator;(function(n){var t=function(){function t(n,t){this.opCode=/^\s*([A-Z]{3})\s*\S*/,this.notWhitespace=/\S/,this.whitespaceTrim=/^\s+/,this.whitespaceTrimEnd=/\s+$/,this.comment=/^\;.*/,this.memoryLabelHex=/^(\$[0-9A-F]+):.*/,this.memoryLabelDec=/^([0-9]+):.*/,this.regularLabel=/^(\w+):.*/,this.memorySet=/^\*\s*\=\s*[\$]?[0-9A-F]*$/,this.setAddress=/^[\s]*\*[\s]*=[\s]*/,this.immediate=/^\#\$?([0-9A-F]{1,3})\s*/,this.immediateLabel=/^\#([<>])(\w+)\s*/,this.absoluteX=/^\$?([0-9A-F]{1,5})(\,\s*X)\s*/,this.absoluteXLabel=/^(\w+)(\,\s*X)\s*/,this.absoluteY=/^\$?([0-9A-F]{1,5})(\,\s*Y)\s*/,this.absoluteYLabel=/^(\w+)(\,\s*Y)\s*/,this.absolute=/^\$?([0-9A-F]{1,5})\s*/,this.absoluteLabel=/^(\w+)\s*/,this.cpu=n,this.consoleService=t,this.opCodeCache={}}return t.prototype.decompile=function(n){for(var t=n&Constants.Memory.Max,i=0,r=[];i<Constants.Memory.MaxInstructionsDecompile&&t<=Constants.Memory.Max;){var u=this.cpu.peek(t),e=[u,this.cpu.peek(t+1),this.cpu.peek(t+2)],f=this.cpu.getOperation(u);r.push(f.decompile(t,e)),i+=1,t+=f.sizeBytes}return r.join("\r\n")},t.prototype.compile=function(n){var f=n.split("\n"),t,r,i,u;this.pcAddress=this.cpu.rPC,this.consoleService.log("Starting compilation.");try{for(t=this.parseLabels(f),t=this.compileSource(t),this.consoleService.log("Compilation complete."),r=0;r<t.compiledLines.length;r++)for(u=t.compiledLines[r],i=0;i<u.code.length;i++)this.cpu.poke(u.address+i,u.code[i]);this.consoleService.log("Code loaded to memory."),this.cpu.rPC=this.pcAddress}catch(e){return this.consoleService.log(e),!1}return!0},t.prototype.parseLabels=function(n){var r=Constants.Memory.DefaultStart,i,h=0,c=0,u,f={labels:[],compiledLines:[]},t,e,o,s;for(this.consoleService.log("Starting compilation pass 1."),u=0;u<n.length;u++)if(t=n[u].toUpperCase(),t=this.trimLine(t),t.match(this.notWhitespace)){if(e=this.moveAddress(t),!isNaN(e)){this.pcAddress=e,r=e;continue}if(t.match(this.memoryLabelHex)||t.match(this.memoryLabelDec)){if(h++,o=t.match(this.memoryLabelHex),i=o?this.memoryLabelHex.exec(t)[1]:this.memoryLabelDec.exec(t)[1],t=t.replace(i+":",""),i=i.replace("$",""),r=parseInt(i,o?16:10),r<0||r>Constants.Memory.Max)throw"Address out of range: "+i;this.pcAddress=r}else if(t.match(this.regularLabel)){if(i=this.regularLabel.exec(t)[1],this.labelExists(i,f.labels))throw"Duplicate label "+i+" found at line "+(u+1);f.labels.push({address:r,labelName:i}),c++,t=t.replace(i+":","")}if(t.match(this.notWhitespace))try{s=this.compileLine(f.labels,r,t),f.compiledLines.push(s),r+=s.code.length}catch(l){throw l+" Line: "+(u+1);}}return this.consoleService.log("Parsed "+h+" memory tags and "+c+" labels."),f},t.prototype.compileLine=function(n,t,i){var r={address:t,code:[],processed:!1,label:"",high:!1};if(i.match(this.opCode))r=this.parseOpCode(n,i,r);else throw"Invalid assembly "+i;return r},t.prototype.trimLine=function(n){return this.notWhitespace.test(n)?this.comment.test(n)?"":n.replace(this.whitespaceTrim,"").replace(this.whitespaceTrimEnd,""):""},t.prototype.moveAddress=function(n){var t,i=NaN;if(n.match(this.memorySet)&&(t=n.replace(this.setAddress,""),t[0]==="$"?(t=t.replace("$",""),i=parseInt(t,16)):i=parseInt(t,10),i<0||i>Constants.Memory.Max))throw"Address out of range";return i},t.prototype.getOperationForMode=function(n,t){for(var i=0,i=0;i<n.length;i++)if(n[i].addressingMode===t)return n[i];return null},t.prototype.parseOpCode=function(t,i,r){var b=this.opCode.exec(i),e,s,h,f,p,w,o,c=b[1],l=[],u,y,v,a;if(c in this.opCodeCache)l=this.opCodeCache[c];else if(l=n.OpCodes.LoadOpCodesByName(c),l.length>0)this.opCodeCache[c]=l;else throw"Invalid op code: "+c;if(a=!0,u=this.trimLine(i.replace(c,"")),!u.match(this.notWhitespace)){if(o=this.getOperationForMode(l,n.OpCodes.ModeSingle),o===null)throw"Opcode requires a parameter "+c;return r.code.push(o.opCode),r.processed=a,r}if(u.match(this.immediate)||(e=u.match(this.immediateLabel))&&(r.high=e[1]===">",y=e[2],v=this.findLabel(y,t),v!==null?(f=r.high?v.address>>Constants.Memory.BitsInByte:v.address,u=u.replace(e[0],"#"+(f&Constants.Memory.ByteMask).toString(10))):(r.label=y,a=!1,u=u.replace(e[0],"#0"))),e=u.match(this.immediate)){if(s=u[1]==="$",h=e[1],f=parseInt(h,s?16:10),f<0||f>Constants.Memory.ByteMask)throw"Immediate value of out range: "+f;if(u=u.replace(s?"#$":"#",""),u=this.trimLine(u.replace(h,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(o=this.getOperationForMode(l,n.OpCodes.ModeImmediate),o===null)throw"Opcode doesn't support immediate mode "+c;return r.code.push(o.opCode),r.code.push(f),r.processed=a,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absoluteX,this.absoluteXLabel),a=r.processed,e=u.match(this.absoluteX)){if(s=u[0]==="$",h=e[1],p=e[2],f=parseInt(h,s?16:10),f<0||f>Constants.Memory.Size)throw"Absolute X-Indexed value of out range: "+f;if(s&&(u=u.replace("$","")),u=u.replace(p,""),u=this.trimLine(u.replace(h,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(o=this.getOperationForMode(l,n.OpCodes.ModeAbsoluteX),o===null)throw"Opcode doesn't support absolute X-indexed mode "+c;return r.code.push(o.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=a,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absoluteY,this.absoluteYLabel),a=r.processed,e=u.match(this.absoluteY)){if(s=u[0]==="$",h=e[1],w=e[2],f=parseInt(h,s?16:10),f<0||f>Constants.Memory.Size)throw"Absolute Y-Indexed value of out range: "+f;if(s&&(u=u.replace("$","")),u=u.replace(w,""),u=this.trimLine(u.replace(h,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(o=this.getOperationForMode(l,n.OpCodes.ModeAbsoluteY),o===null)throw"Opcode doesn't support absolute Y-indexed mode "+c;return r.code.push(o.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=!0,r}if(r.processed=!0,u=this.parseAbsoluteLabel(u,r,t,this.absolute,this.absoluteLabel),a=r.processed,e=u.match(this.absolute)){if(s=u[0]==="$",h=e[1],f=parseInt(h,s?16:10),f<0||f>Constants.Memory.Size)throw"Absolute value of out range: "+f;if(s&&(u=u.replace("$","")),u=this.trimLine(u.replace(h,"")),u.match(this.notWhitespace)&&!u.match(this.comment))throw"Invalid assembly: "+i;if(o=this.getOperationForMode(l,n.OpCodes.ModeAbsolute),o===null)throw"Opcode doesn't support absolute mode "+c;return r.code.push(o.opCode),r.code.push(f&Constants.Memory.ByteMask),r.code.push(f>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask),r.processed=!0,r}return r},t.prototype.compileSource=function(n){var r,t,i,u;for(this.consoleService.log("Starting compilation pass 2."),r=0;r<n.compiledLines.length;r++)if(t=n.compiledLines[r],!t.processed){if(i=this.findLabel(t.label,n.labels),i===null)throw"Label not defined: "+t.label;if(t.code.length===2){u=t.high?i.address>>Constants.Memory.BitsInByte:i.address,t.code[1]=u&Constants.Memory.ByteMask,t.processed=!0;continue}else if(t.code.length===3){t.code[1]=i.address&Constants.Memory.ByteMask,t.code[2]=i.address>>Constants.Memory.BitsInByte&Constants.Memory.ByteMask,t.processed=!0;continue}throw"Not implemented";}return n},t.prototype.labelExists=function(n,t){return this.findLabel(n,t)!==null},t.prototype.findLabel=function(n,t){for(var i=0;i<t.length;i++)if(t[i].labelName===n)return t[i];return null},t.prototype.parseAbsoluteLabel=function(n,t,i,r,u){var f,e,o,s;return n.match(r)||(f=n.match(u))&&(e=f[1],o=this.findLabel(e,i),o!==null?(s=o.address,n=n.replace(f[1],s.toString(10))):(t.label=e,t.processed=!1,n=n.replace(f[1],"0"))),n},t}();n.Compiler=t})(Emulator||(Emulator={}))